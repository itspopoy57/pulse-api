generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BlockedUser {
  id                               Int      @id @default(autoincrement())
  blockerId                        Int
  blockedId                        Int
  reason                           String?
  createdAt                        DateTime @default(now())
  User_BlockedUser_blockedIdToUser User     @relation("BlockedUser_blockedIdToUser", fields: [blockedId], references: [id], onDelete: Cascade)
  User_BlockedUser_blockerIdToUser User     @relation("BlockedUser_blockerIdToUser", fields: [blockerId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockedId])
  @@index([blockerId])
}

model Comment {
  id              Int               @id @default(autoincrement())
  text            String
  isAnonymous     Boolean           @default(true)
  authorId        Int
  postId          Int
  createdAt       DateTime          @default(now())
  isHidden        Boolean           @default(false)
  isReported      Boolean           @default(false)
  reportedCount   Int               @default(0)
  likeCount       Int               @default(0)
  parentId        Int?
  mediaType       String?
  mediaUrl        String?
  moderatedAt     DateTime?
  moderatedBy     Int?
  moderationNote  String?
  User            User              @relation(fields: [authorId], references: [id])
  Comment         Comment?          @relation("CommentToComment", fields: [parentId], references: [id])
  other_Comment   Comment[]         @relation("CommentToComment")
  Post            Post              @relation(fields: [postId], references: [id])
  CommentReaction CommentReaction[]
}

model CommentReaction {
  id        Int                @id @default(autoincrement())
  type      ReactionType?
  userId    Int
  commentId Int
  createdAt DateTime           @default(now())
  emoji     EmojiReactionType?
  Comment   Comment            @relation(fields: [commentId], references: [id], onDelete: Cascade)
  User      User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([commentId])
}

model Connection {
  id                                Int              @id @default(autoincrement())
  requesterId                       Int
  receiverId                        Int
  status                            ConnectionStatus @default(PENDING)
  createdAt                         DateTime         @default(now())
  updatedAt                         DateTime
  acceptedAt                        DateTime?
  User_Connection_receiverIdToUser  User             @relation("Connection_receiverIdToUser", fields: [receiverId], references: [id], onDelete: Cascade)
  User_Connection_requesterIdToUser User             @relation("Connection_requesterIdToUser", fields: [requesterId], references: [id], onDelete: Cascade)

  @@unique([requesterId, receiverId])
  @@index([receiverId])
  @@index([requesterId])
  @@index([status])
}

model Conversation {
  id                              Int       @id @default(autoincrement())
  user1Id                         Int
  user2Id                         Int
  lastMessageAt                   DateTime  @default(now())
  lastMessageText                 String?
  createdAt                       DateTime  @default(now())
  updatedAt                       DateTime
  User_Conversation_user1IdToUser User      @relation("Conversation_user1IdToUser", fields: [user1Id], references: [id], onDelete: Cascade)
  User_Conversation_user2IdToUser User      @relation("Conversation_user2IdToUser", fields: [user2Id], references: [id], onDelete: Cascade)
  Message                         Message[]

  @@unique([user1Id, user2Id])
  @@index([lastMessageAt])
  @@index([user1Id])
  @@index([user2Id])
}

model Group {
  id              Int            @id @default(autoincrement())
  name            String         @db.VarChar(100)
  description     String?
  avatarUrl       String?
  creatorId       Int
  lastMessageAt   DateTime?
  lastMessageText String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime
  User            User           @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  GroupMember     GroupMember[]
  GroupMessage    GroupMessage[]
  GroupTyping     GroupTyping[]

  @@index([creatorId])
  @@index([lastMessageAt])
}

model GroupMember {
  id       Int       @id @default(autoincrement())
  groupId  Int
  userId   Int
  role     GroupRole @default(MEMBER)
  isMuted  Boolean   @default(false)
  joinedAt DateTime  @default(now())
  Group    Group     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  User     User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
}

model GroupMessage {
  id               Int                @id @default(autoincrement())
  groupId          Int
  senderId         Int
  text             String?
  mediaUrl         String?
  mediaType        String?
  fileName         String?
  isDeleted        Boolean            @default(false)
  deletedAt        DateTime?
  deletedBy        Int?
  createdAt        DateTime           @default(now())
  Group            Group              @relation(fields: [groupId], references: [id], onDelete: Cascade)
  User             User               @relation(fields: [senderId], references: [id], onDelete: Cascade)
  GroupMessageRead GroupMessageRead[]

  @@index([createdAt])
  @@index([groupId, createdAt])
  @@index([groupId])
  @@index([senderId])
}

model GroupMessageRead {
  id           Int          @id @default(autoincrement())
  messageId    Int
  userId       Int
  readAt       DateTime     @default(now())
  GroupMessage GroupMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  User         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
}

model GroupTyping {
  id        Int      @id @default(autoincrement())
  groupId   Int
  userId    Int
  updatedAt DateTime
  Group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([updatedAt])
}

model Hashtag {
  id          Int           @id @default(autoincrement())
  useCount    Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime
  tag         String        @unique
  PostHashtag PostHashtag[]

  @@index([tag])
  @@index([useCount])
}

model Message {
  id                            Int               @id @default(autoincrement())
  conversationId                Int
  senderId                      Int
  receiverId                    Int
  text                          String?
  mediaUrl                      String?
  mediaType                     String?
  fileName                      String?
  isRead                        Boolean           @default(false)
  readAt                        DateTime?
  createdAt                     DateTime          @default(now())
  isDeleted                     Boolean           @default(false)
  deletedAt                     DateTime?
  deletedBy                     Int?
  Conversation                  Conversation      @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  User_Message_receiverIdToUser User              @relation("Message_receiverIdToUser", fields: [receiverId], references: [id], onDelete: Cascade)
  User_Message_senderIdToUser   User              @relation("Message_senderIdToUser", fields: [senderId], references: [id], onDelete: Cascade)
  MessageReaction               MessageReaction[]

  @@index([conversationId])
  @@index([createdAt])
  @@index([isDeleted])
  @@index([receiverId])
  @@index([senderId])
}

model MessageReaction {
  id        Int      @id @default(autoincrement())
  messageId Int
  userId    Int
  emoji     String
  createdAt DateTime @default(now())
  Message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
}

model Notification {
  id             Int       @id @default(autoincrement())
  userId         Int
  type           String
  title          String
  body           String
  fromUserId     Int?
  postId         Int?
  commentId      Int?
  conversationId Int?
  groupId        Int?
  isRead         Boolean   @default(false)
  readAt         DateTime?
  data           Json?
  createdAt      DateTime  @default(now())
  User           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
  @@index([userId, isRead])
}

model Poll {
  id            Int          @id @default(autoincrement())
  postId        Int          @unique
  allowMultiple Boolean      @default(false)
  maxChoices    Int?
  endsAt        DateTime?
  totalVotes    Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime
  Post          Post         @relation(fields: [postId], references: [id], onDelete: Cascade)
  PollOption    PollOption[]
  PollVote      PollVote[]

  @@index([postId])
}

model PollOption {
  id        Int        @id @default(autoincrement())
  pollId    Int
  text      String     @db.VarChar(100)
  order     Int
  voteCount Int        @default(0)
  createdAt DateTime   @default(now())
  Poll      Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  PollVote  PollVote[]

  @@index([pollId])
  @@index([pollId, order])
}

model PollVote {
  id         Int        @id @default(autoincrement())
  pollId     Int
  optionId   Int
  userId     Int
  createdAt  DateTime   @default(now())
  PollOption PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  Poll       Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  User       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, pollId, optionId])
  @@index([optionId])
  @@index([pollId])
  @@index([userId])
}

model Post {
  id             Int            @id @default(autoincrement())
  type           PostType
  title          String
  body           String?
  sideA          String?
  sideB          String?
  votesA         Int            @default(0)
  votesB         Int            @default(0)
  upvotes        Int            @default(0)
  downvotes      Int            @default(0)
  isAnonymous    Boolean        @default(true)
  region         String?
  authorId       Int
  createdAt      DateTime       @default(now())
  isHidden       Boolean        @default(false)
  isReported     Boolean        @default(false)
  reportedCount  Int            @default(0)
  mediaType      String?
  mediaUrl       String?
  moderatedAt    DateTime?
  moderatedBy    Int?
  moderationNote String?
  Comment        Comment[]
  Poll           Poll?
  User           User           @relation(fields: [authorId], references: [id])
  PostHashtag    PostHashtag[]
  PostReaction   PostReaction[]
  SavedPost      SavedPost[]
  VsVote         VsVote[]

  @@index([createdAt])
}

model PostHashtag {
  id        Int      @id @default(autoincrement())
  postId    Int
  hashtagId Int
  createdAt DateTime @default(now())
  Hashtag   Hashtag  @relation(fields: [hashtagId], references: [id], onDelete: Cascade)
  Post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, hashtagId])
  @@index([hashtagId])
  @@index([postId])
}

model PostReaction {
  id     Int          @id @default(autoincrement())
  type   ReactionType
  userId Int
  postId Int
  Post   Post         @relation(fields: [postId], references: [id])
  User   User         @relation(fields: [userId], references: [id])

  @@unique([userId, postId])
}

model SavedPost {
  id        Int      @id @default(autoincrement())
  userId    Int
  postId    Int
  createdAt DateTime @default(now())
  Post      Post     @relation(fields: [postId], references: [id])
  User      User     @relation(fields: [userId], references: [id])

  @@unique([userId, postId])
}

model User {
  id                                      Int                @id @default(autoincrement())
  email                                   String             @unique
  passwordHash                            String
  username                                String?            @unique
  region                                  String?
  createdAt                               DateTime           @default(now())
  avatarUrl                               String?
  bio                                     String?
  displayName                             String?
  bannedAt                                DateTime?
  bannedReason                            String?
  isAdmin                                 Boolean            @default(false)
  isBanned                                Boolean            @default(false)
  notificationsEnabled                    Boolean            @default(true)
  notifyComments                          Boolean            @default(true)
  notifyMentions                          Boolean            @default(true)
  notifyMessages                          Boolean            @default(true)
  notifyReactions                         Boolean            @default(true)
  pushPlatform                            String?
  pushToken                               String?
  notifyConnections                       Boolean            @default(true)
  theme                                   String?            @default("dark")
  BlockedUser_BlockedUser_blockedIdToUser BlockedUser[]      @relation("BlockedUser_blockedIdToUser")
  BlockedUser_BlockedUser_blockerIdToUser BlockedUser[]      @relation("BlockedUser_blockerIdToUser")
  Comment                                 Comment[]
  CommentReaction                         CommentReaction[]
  Connection_Connection_receiverIdToUser  Connection[]       @relation("Connection_receiverIdToUser")
  Connection_Connection_requesterIdToUser Connection[]       @relation("Connection_requesterIdToUser")
  Conversation_Conversation_user1IdToUser Conversation[]     @relation("Conversation_user1IdToUser")
  Conversation_Conversation_user2IdToUser Conversation[]     @relation("Conversation_user2IdToUser")
  Group                                   Group[]
  GroupMember                             GroupMember[]
  GroupMessage                            GroupMessage[]
  GroupMessageRead                        GroupMessageRead[]
  GroupTyping                             GroupTyping[]
  Message_Message_receiverIdToUser        Message[]          @relation("Message_receiverIdToUser")
  Message_Message_senderIdToUser          Message[]          @relation("Message_senderIdToUser")
  MessageReaction                         MessageReaction[]
  Notification                            Notification[]
  PollVote                                PollVote[]
  Post                                    Post[]
  PostReaction                            PostReaction[]
  SavedPost                               SavedPost[]
  VsVote                                  VsVote[]
}

model VsVote {
  id     Int    @id @default(autoincrement())
  side   VsSide
  userId Int
  postId Int
  Post   Post   @relation(fields: [postId], references: [id])
  User   User   @relation(fields: [userId], references: [id])

  @@unique([userId, postId])
}

enum ConnectionStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum EmojiReactionType {
  LIKE
  LOVE
  FIRE
  LAUGH
  WOW
  SAD
  ANGRY
}

enum GroupRole {
  ADMIN
  MEMBER
}

enum PostType {
  HOT_TAKE
  CONFESSION
  QUESTION
  VS
  POLL
}

enum ReactionType {
  UPVOTE
  DOWNVOTE
}

enum VsSide {
  A
  B
}
